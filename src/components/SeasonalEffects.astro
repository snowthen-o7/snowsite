---
// Determine current season based on month
const month = new Date().getMonth(); // 0-11

type Season = 'winter' | 'spring' | 'summer' | 'fall';

function getSeason(month: number): Season {
  if (month >= 11 || month <= 1) return 'winter';  // Dec, Jan, Feb
  if (month >= 2 && month <= 4) return 'spring';   // Mar, Apr, May
  if (month >= 5 && month <= 7) return 'summer';   // Jun, Jul, Aug
  return 'fall';                                    // Sep, Oct, Nov
}

// Allow URL parameter override for testing: ?season=fall, ?season=spring, etc.
const urlSeason = Astro.url.searchParams.get('season') as Season | null;
const validSeasons: Season[] = ['winter', 'spring', 'summer', 'fall'];
const season = (urlSeason && validSeasons.includes(urlSeason)) ? urlSeason : getSeason(month);

// Configuration per season
const config = {
  winter: { count: 50, enabled: true },
  spring: { count: 30, enabled: true },
  summer: { count: 0, enabled: false },
  fall: { count: 40, enabled: true },
};

const { count, enabled } = config[season];

// Pre-generate random values for each particle
const particles = Array.from({ length: count }).map(() => ({
  left: Math.random() * 100,
  size: 4 + Math.random() * 6,
  duration: 8 + Math.random() * 7,
  delay: Math.random() * -15,
  drift: -30 + Math.random() * 60,
  opacity: 0.4 + Math.random() * 0.5,
}));
---

{enabled && (
  <div class="seasonal-effects" data-season={season} aria-hidden="true">
    {particles.map((p, i) => (
      <div
        class="particle"
        style={`
          left: ${p.left}%;
          width: ${p.size}px;
          height: ${p.size}px;
          animation-duration: ${p.duration}s;
          animation-delay: ${p.delay}s;
          --drift: ${p.drift}px;
          --opacity: ${p.opacity};
        `}
      />
    ))}
  </div>
)}

<style>
  .seasonal-effects {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1000;
    overflow: hidden;
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .seasonal-effects {
      display: none;
    }
  }

  .particle {
    position: absolute;
    top: -20px;
  }

  /* Winter - Snowflakes */
  [data-season="winter"] .particle {
    background: white;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
    animation-name: fall-snow;
    animation-timing-function: linear;
    animation-iteration-count: infinite;
  }

  @keyframes fall-snow {
    0% {
      transform: translateY(0) translateX(0);
      opacity: 0;
    }
    5% {
      opacity: var(--opacity, 0.6);
    }
    50% {
      transform: translateY(50vh) translateX(calc(var(--drift, 0px) * 0.5));
    }
    95% {
      opacity: var(--opacity, 0.6);
    }
    100% {
      transform: translateY(100vh) translateX(var(--drift, 0px));
      opacity: 0;
    }
  }

  /* Fall - Leaves */
  [data-season="fall"] .particle {
    border-radius: 0 70% 0 70%;
    animation-name: fall-leaf;
    animation-timing-function: ease-in-out;
    animation-iteration-count: infinite;
  }

  /* Varied fall colors */
  [data-season="fall"] .particle:nth-child(5n) {
    background: #c2410c;
  }
  [data-season="fall"] .particle:nth-child(5n+1) {
    background: #b91c1c;
  }
  [data-season="fall"] .particle:nth-child(5n+2) {
    background: #a16207;
  }
  [data-season="fall"] .particle:nth-child(5n+3) {
    background: #9a3412;
  }
  [data-season="fall"] .particle:nth-child(5n+4) {
    background: #7c2d12;
  }

  @keyframes fall-leaf {
    0% {
      transform: translateY(0) translateX(0) rotate(0deg);
      opacity: 0;
    }
    5% {
      opacity: var(--opacity, 0.7);
    }
    25% {
      transform: translateY(25vh) translateX(calc(var(--drift, 0px) * 0.3)) rotate(90deg);
    }
    50% {
      transform: translateY(50vh) translateX(calc(var(--drift, 0px) * -0.2)) rotate(180deg);
    }
    75% {
      transform: translateY(75vh) translateX(calc(var(--drift, 0px) * 0.8)) rotate(270deg);
    }
    95% {
      opacity: var(--opacity, 0.7);
    }
    100% {
      transform: translateY(100vh) translateX(var(--drift, 0px)) rotate(360deg);
      opacity: 0;
    }
  }

  /* Spring - Cherry blossom petals */
  [data-season="spring"] .particle {
    border-radius: 70% 0 70% 0;
    animation-name: fall-petal;
    animation-timing-function: ease-in-out;
    animation-iteration-count: infinite;
  }

  [data-season="spring"] .particle:nth-child(3n) {
    background: #fce7f3;
  }
  [data-season="spring"] .particle:nth-child(3n+1) {
    background: #fbcfe8;
  }
  [data-season="spring"] .particle:nth-child(3n+2) {
    background: #f9a8d4;
  }

  @keyframes fall-petal {
    0% {
      transform: translateY(0) translateX(0) rotate(0deg) scale(1);
      opacity: 0;
    }
    5% {
      opacity: var(--opacity, 0.6);
    }
    33% {
      transform: translateY(33vh) translateX(calc(var(--drift, 0px) * 0.5)) rotate(120deg) scale(0.95);
    }
    66% {
      transform: translateY(66vh) translateX(calc(var(--drift, 0px) * -0.3)) rotate(240deg) scale(0.9);
    }
    95% {
      opacity: var(--opacity, 0.6);
    }
    100% {
      transform: translateY(100vh) translateX(var(--drift, 0px)) rotate(360deg) scale(0.85);
      opacity: 0;
    }
  }

  /* Reduce particle count on mobile for performance */
  @media (max-width: 600px) {
    .particle:nth-child(n+25) {
      display: none;
    }
  }
</style>
