---
// Determine current season based on month
const month = new Date().getMonth(); // 0-11

type Season = 'winter' | 'spring' | 'summer' | 'fall';

function getSeason(month: number): Season {
  if (month >= 11 || month <= 1) return 'winter';  // Dec, Jan, Feb
  if (month >= 2 && month <= 4) return 'spring';   // Mar, Apr, May
  if (month >= 5 && month <= 7) return 'summer';   // Jun, Jul, Aug
  return 'fall';                                    // Sep, Oct, Nov
}

// In static mode, we use the date-based season. Client-side JS handles ?season= override for testing.
const season = getSeason(month);

// Configuration per season
const config = {
  winter: {
    count: 50,
    enabled: true,
    size: () => 4 + Math.random() * 6,
    duration: () => 8 + Math.random() * 7,
    delay: () => Math.random() * -15,
    sway: () => 20 + Math.random() * 40,
    opacity: () => 0.4 + Math.random() * 0.5,
  },
  spring: {
    count: 35,
    enabled: true,
    size: () => 6 + Math.random() * 8,
    duration: () => 10 + Math.random() * 8,
    delay: () => Math.random() * -18,
    sway: () => 30 + Math.random() * 50,
    opacity: () => 0.5 + Math.random() * 0.4,
  },
  summer: {
    count: 0,
    enabled: false,
    size: () => 0,
    duration: () => 0,
    delay: () => 0,
    sway: () => 0,
    opacity: () => 0,
  },
  fall: {
    count: 40,
    enabled: true,
    size: () => 8 + Math.random() * 10,
    duration: () => 12 + Math.random() * 8,
    delay: () => Math.random() * -20,
    sway: () => 40 + Math.random() * 60,
    opacity: () => 0.6 + Math.random() * 0.3,
  },
};

const seasonConfig = config[season];
const { count, enabled } = seasonConfig;

// Pre-generate random values for each particle with season-specific properties
const particles = Array.from({ length: count }).map(() => ({
  left: Math.random() * 100,
  size: seasonConfig.size(),
  duration: seasonConfig.duration(),
  delay: seasonConfig.delay(),
  sway: seasonConfig.sway(),
  swayDuration: 2 + Math.random() * 3, // 2-5 seconds for horizontal sway
  spinDirection: Math.random() > 0.5 ? 1 : -1, // clockwise or counter-clockwise
  opacity: seasonConfig.opacity(),
}));
---

{enabled && (
  <div class="seasonal-effects" data-season={season} aria-hidden="true">
    {particles.map((p, i) => (
      <div
        class="particle-wrapper"
        style={`
          left: ${p.left}%;
          --fall-duration: ${p.duration}s;
          --delay: ${p.delay}s;
        `}
      >
        <div
          class="particle"
          style={`
            width: ${p.size}px;
            height: ${p.size}px;
            --sway-duration: ${p.swayDuration}s;
            --sway: ${p.sway}px;
            --spin-direction: ${p.spinDirection};
            --opacity: ${p.opacity};
          `}
        />
      </div>
    ))}
  </div>
)}

<script>
  // Client-side season override for testing via ?season= parameter
  const params = new URLSearchParams(window.location.search);
  const seasonParam = params.get('season');
  const validSeasons = ['winter', 'spring', 'summer', 'fall'];

  if (seasonParam && validSeasons.includes(seasonParam)) {
    const el = document.querySelector('.seasonal-effects');
    if (el) {
      el.setAttribute('data-season', seasonParam);
      console.log('Season overridden to:', seasonParam);
    }
  }
</script>

<style is:global>
  .seasonal-effects {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1000;
    overflow: hidden;
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .seasonal-effects {
      display: none;
    }
  }

  /* Wrapper handles vertical falling only */
  .particle-wrapper {
    position: absolute;
    top: -20px;
    animation: fall var(--fall-duration) linear infinite;
    animation-delay: var(--delay);
  }

  /* Inner particle handles appearance, sway, and spin */
  .particle {
    opacity: var(--opacity, 0.6);
  }

  /* Winter - Snowflakes */
  [data-season="winter"] .particle {
    background: white;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
    animation: sway var(--sway-duration) ease-in-out infinite;
  }

  /* Fall - Leaves */
  [data-season="fall"] .particle {
    border-radius: 0 70% 0 70%;
    animation:
      sway var(--sway-duration) ease-in-out infinite,
      spin calc(var(--sway-duration) * 2) linear infinite;
  }

  /* Varied fall colors - using wrapper nth-child since particle is nested */
  [data-season="fall"] .particle-wrapper:nth-child(5n) .particle { background: #c2410c; }
  [data-season="fall"] .particle-wrapper:nth-child(5n+1) .particle { background: #b91c1c; }
  [data-season="fall"] .particle-wrapper:nth-child(5n+2) .particle { background: #a16207; }
  [data-season="fall"] .particle-wrapper:nth-child(5n+3) .particle { background: #9a3412; }
  [data-season="fall"] .particle-wrapper:nth-child(5n+4) .particle { background: #7c2d12; }

  /* Spring - Cherry blossom petals */
  [data-season="spring"] .particle {
    border-radius: 70% 0 70% 0;
    animation:
      sway var(--sway-duration) ease-in-out infinite,
      spin calc(var(--sway-duration) * 3) ease-in-out infinite;
  }

  [data-season="spring"] .particle-wrapper:nth-child(3n) .particle { background: #fce7f3; }
  [data-season="spring"] .particle-wrapper:nth-child(3n+1) .particle { background: #fbcfe8; }
  [data-season="spring"] .particle-wrapper:nth-child(3n+2) .particle { background: #f9a8d4; }

  /* Falling animation - vertical movement on wrapper */
  @keyframes fall {
    0% {
      transform: translateY(0);
    }
    100% {
      transform: translateY(calc(100vh + 40px));
    }
  }

  /* Swaying animation - horizontal oscillation */
  @keyframes sway {
    0%, 100% {
      transform: translateX(0);
    }
    50% {
      transform: translateX(var(--sway, 30px));
    }
  }

  /* Rotation animation - uses spin-direction for clockwise/counter-clockwise */
  @keyframes spin {
    0% {
      rotate: 0deg;
    }
    100% {
      rotate: calc(360deg * var(--spin-direction, 1));
    }
  }

  /* Reduce particle count on mobile for performance */
  @media (max-width: 600px) {
    .particle-wrapper:nth-child(n+25) {
      display: none;
    }
  }
</style>
